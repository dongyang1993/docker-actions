name: Sync Images to Aliyun Multi Arch

on:
  workflow_dispatch:
  push:
    paths:
      - "images.txt"

# 防止并发运行时产生冲突，同一分支只允许一个任务运行
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-images:
    runs-on: ubuntu-latest
    # 设置超时时间，防止脚本卡死消耗额度
    timeout-minutes: 60
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Skopeo
        run: |
          # 安装 Skopeo 工具
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Sync Images (Multi-Arch)
        run: |
          # 检查 images.txt 是否存在
          if [ ! -f images.txt ]; then
            echo "images.txt not found!"
            exit 1
          fi

          while IFS= read -r line || [[ -n "$line" ]]; do
            # 去除首尾空格
            image=$(echo "$line" | xargs)

            # 跳过空行和注释
            if [[ -z "$image" || "$image" == \#* ]]; then
              continue
            fi

            echo "----------------------------------------"
            echo "正在处理镜像 (多架构): $image"

            # 处理目标镜像名称
            # 逻辑：提取镜像名最后一部分
            image_name_tag=$(echo "$image" | tr '/' '_')

            # 构造阿里云目标地址
            new_image="${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/$image_name_tag"

            echo "源: $image"
            echo "目标: $new_image"

            # 使用 Skopeo 复制
            # --all: 复制所有架构 (amd64, arm64, etc.)
            # --src-tls-verify=false: 有些源(如http)可能需要关闭校验，通常dockerhub不需要，可根据情况删除
            # --dest-creds: 指定阿里云的账号密码

            skopeo copy --all --retry-times 3 \
              --dest-creds "${{ secrets.ALIYUN_USERNAME }}:${{ secrets.ALIYUN_PASSWORD }}" \
              docker://$image \
              docker://$new_image

            echo "同步完成: $new_image"

          done < images.txt
