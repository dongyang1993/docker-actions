name: Sync Images to Aliyun Multi Arch

on:
  workflow_dispatch:
  push:
    paths:
      - "images.txt"

jobs:
  sync-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Skopeo
        run: |
          # æ£€æŸ¥ Skopeo æ˜¯å¦å·²å®‰è£…ï¼Œæœªå®‰è£…åˆ™å®‰è£…
          if ! command -v skopeo &> /dev/null; then
            echo "Installing Skopeo..."
            sudo apt-get update
            sudo apt-get install -y skopeo
          else
            echo "Skopeo is already installed."
            skopeo --version
          fi

      - name: Sync Images (Multi-Arch)
        run: |
          # 0. é¢„æ£€æŸ¥
          if [ ! -f images.txt ]; then
            echo "Error: images.txt not found!"
            exit 1
          fi

          # 1. ç™»å½•é˜¿é‡Œäº‘ (é¿å…åœ¨å¾ªç¯ä¸­é‡å¤ä¼ å‚ï¼Œä¸”é¿å…æ—¥å¿—æ³„éœ²é£é™©)
          echo "Logging into Aliyun..."
          skopeo login -u "${{ secrets.ALIYUN_USERNAME }}" -p "${{ secrets.ALIYUN_PASSWORD }}" ${{ secrets.ALIYUN_REGISTRY }}

          # å®šä¹‰ç»Ÿè®¡å˜é‡
          TOTAL_COUNT=0
          SUCCESS_COUNT=0
          FAIL_COUNT=0
          FAILED_IMAGES=""

          echo "Starting sync process..."

          while IFS= read -r line || [[ -n "$line" ]]; do
            # å»é™¤é¦–å°¾ç©ºæ ¼
            image=$(echo "$line" | xargs)

            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            if [[ -z "$image" || "$image" == \#* ]]; then
              continue
            fi

            ((TOTAL_COUNT++))
            echo "----------------------------------------"
            echo "[${TOTAL_COUNT}] Processing: $image"

            # 2. ä¼˜åŒ–å‘½åé€»è¾‘ï¼šé˜²æ­¢é‡åè¦†ç›–
            # å°† 'bitnami/mysql:8.0' è½¬æ¢ä¸º 'bitnami_mysql:8.0'
            # å°† 'nginx:latest' ä¿æŒä¸º 'nginx:latest' (å› ä¸ºæ²¡æœ‰æ–œæ )
            # å¦‚æœæºæ˜¯ 'gcr.io/google-containers/pause:3.2' -> 'gcr.io_google-containers_pause:3.2'
            # è¿™æ ·å¯ä»¥æœ€å¤§ç¨‹åº¦ä¿ç•™åŸå§‹ä¿¡æ¯ä¸”ä¸å†²çª

            # ç§»é™¤ Docker Hub çš„å®˜æ–¹å‰ç¼€ library/ (å¯é€‰ï¼Œçœ‹ä½ å–œå¥½)
            clean_image=${image#"library/"}

            # å°†åç§°ä¸­çš„ / æ›¿æ¢ä¸º _
            # é€»è¾‘ï¼šæå–é•œåƒåï¼ˆä¸å«tagï¼‰ï¼Œæ›¿æ¢/ï¼Œç„¶åå†æ‹¼å›tag
            # è¿™é‡Œç®€å•å¤„ç†ï¼šç›´æ¥æŠŠæ•´ä¸ªå­—ç¬¦ä¸²çš„ / æ¢æˆ _ (é™¤äº† tag éƒ¨åˆ†)
            # ä½†æ›´ç¨³å¦¥çš„æ˜¯åªå¤„ç† namespace éƒ¨åˆ†

            # ç®€å•ç­–ç•¥ï¼šä¿ç•™ Tagï¼Œå°†é•œåƒåéƒ¨åˆ†çš„ / æ›¿æ¢ä¸º _
            IMG_NAME=$(echo "$image" | cut -d':' -f1)
            IMG_TAG=$(echo "$image" | cut -d':' -f2)

            # å¦‚æœæ²¡æœ‰ tagï¼Œé»˜è®¤ latest
            if [ "$IMG_NAME" == "$IMG_TAG" ]; then IMG_TAG="latest"; fi

            # æ›¿æ¢é•œåƒåä¸­çš„æ–œæ 
            #SAFE_NAME=$(echo "$IMG_NAME" | tr '/' '_')
            SAFE_NAME=$(echo "$IMG_NAME" | tr '/' '_')

            # æ„é€ æœ€ç»ˆç›®æ ‡
            TARGET_IMAGE="${{ secrets.ALIYUN_REGISTRY }}/${{ secrets.ALIYUN_NAMESPACE }}/${SAFE_NAME}:${IMG_TAG}"

            echo "Src: $image"
            echo "Dst: $TARGET_IMAGE"

            # 3. æ‰§è¡ŒåŒæ­¥ (å¢åŠ é‡è¯•æœºåˆ¶)
            # --retry-times 3: å¤±è´¥é‡è¯•3æ¬¡
            # --insecure-policy: å…è®¸æŸäº›éæ ‡å‡†ç­–ç•¥ï¼ˆå¯é€‰ï¼‰
            # --format=docker: ç¡®ä¿è¾“å‡ºæ ¼å¼å…¼å®¹æ€§

            if skopeo copy --all --retry-times 3 --format=docker docker://$image docker://$TARGET_IMAGE; then
              echo "âœ… Success: $image"
              ((SUCCESS_COUNT++))
            else
              echo "âŒ Failed: $image"
              ((FAIL_COUNT++))
              FAILED_IMAGES+="$image\n"
            fi

          done < images.txt

          echo "========================================"
          echo "Sync Summary:"
          echo "Total: $TOTAL_COUNT"
          echo "Success: $SUCCESS_COUNT"
          echo "Failed: $FAIL_COUNT"

          if [ "$FAIL_COUNT" -gt 0 ]; then
            echo "The following images failed to sync:"
            echo -e "$FAILED_IMAGES"
            exit 1
          else
            echo "ğŸ‰ All images synced successfully!"
          fi
